webpackJsonp([82],[function(e,i,a){"use strict";var n=a(1),t=a(3);a(26),n.prepare({requireLogin:!1},function(){var e={},i="领取卡券",a="已领取";e.load=function(e){var i=this;if(i.type=e.type,"restore"==i.type){var a="wxcard/canRestore?"+n.buildQuery({order_id:e.order_id||"",card_id:e.card_id||"",code:e.card_code||""});n.apiRequest("GET",a,null,function(a){var n=a.card_infos||[];if(n.length>0){var t=n[0];e.isEnable=!0,e.title=t.title,e.brand_name=t.brand_name}else{var t={title:"已领取",brand_name:Config.shop.name};n.push(t),e.isEnable=!1,e.title=t.title,e.brand_name=t.brand_name}i.dataReady(n,e)},function(){t.hide()})}else if("get"==i.type){var a="wxcard/canGet?"+n.buildQuery({card_id:e.card_id||""});n.apiRequest("GET",a,null,function(a){var n=a.card_infos||[];if(n.length>0){var t=n[0];e.title=t.title,e.brand_name=t.brand_name,e.isEnable=!0}else{var t={title:"已领取",brand_name:Config.shop.name};n.push(t),e.isEnable=!1,e.title=t.title,e.brand_name=t.brand_name}i.dataReady(n,e)},function(){t.hide()})}else if("fission"==i.type){var a="wxcard/canFission?"+n.buildQuery({card_id:e.card_id||""});n.apiRequest("GET",a,null,function(a){var n=a.code_list,t=[];for(var r in n)t.push(r);e.code=t;var d=a.card_info;e.title=d.title,e.brand_name=d.brand_name,i.dataReady(t,e)},function(){t.hide()})}else t.hide()},e.setupModel=function(n,r){var d=this,s=n.length>0;return d.toggleBtn(!s),null==d.vm&&(d.vm=avalon.define({$id:"card",isVisible:s,isFission:"fission"==e.type,isEnable:r.isEnable,cardInfos:n,shopName:Config.shop.name,title:r.title||"",brand_name:r.brand_name||"",cardBtnText:s?i:a,query_params:r,click:function(i){return d.vm.isFission||d.vm.isEnable?(t.show(),null!=window.wx&&s?void d.getWXCardInfos(function(i){var n=[],r=d.vm.query_params.card_id||"";if("fission"==d.type)for(var s=d.vm.cardInfos,o=0;o<s.length;o++){var c=s[o],l=d.calSign(i,r,c,function(e){}),f={cardId:r,cardExt:l};n.push(f)}else if("get"==d.type||"restore"==d.type){var c=d.vm.query_params.card_code||"",l=d.calSign(i,r,c,function(e){}),f={cardId:r,cardExt:l};n.push(f)}window.wx.addCard({cardList:n,success:function(i){var n=d.vm.query_params;n.cardList=i.cardList,d.confirm(n,function(i){if(d.vm.isFission){if(i.length==d.vm.cardInfos.length)d.vm.isVisible=!1,d.vm.cardBtnText=a,e.toggleBtn(!0);else if(i.length>0)for(var n=0;n<i.length;n++)for(var t=0;t<d.vm.cardInfos.length;t++)i[n]==d.vm.cardInfos[t]&&d.vm.cardInfos.splice(t,1)}else d.vm.title=a,d.vm.isEnable=!1})}}),t.hide()}):void t.hide()):void 0}})),d.setUI(),t.hide(),d.vm},e.dataReady=function(e,i){if(void 0==e||null==e)return void t.hide();var a=this;a.setupModel(e,i);avalon.scan(document.body),e.length<=0&&t.hide()},e.getParameters=function(){var e=location.search,i={};if(""===e||void 0===e)return i;e=e.substr(1).split("&");for(var a in e){var n=e[a].split("=");i[n[0]]=n[1]}return i.from&&delete i.code,i},e.getWXCardInfos=function(e){var i="wxcard/getWxCardTicket?";n.apiRequest("GET",i,null,function(i){var a=i.wx_card_ticket;e(a)},function(){})},e.calSign=function(i,a,n,t){if("get"!=e.type&&"fission"!=e.type||""==n){var r=parseInt((new Date).getTime()/1e3),d=[i,a,r];d.sort();var s=d.join("");t(s);var o=hex_sha1(s),c=JSON.stringify({timestamp:r,signature:o})}else{var r=parseInt((new Date).getTime()/1e3),d=[i,a,r,n];d.sort();var s=d.join("");t(s);var o=hex_sha1(s),c=JSON.stringify({timestamp:r,signature:o,code:n})}return c},e.confirm=function(e,i){var a=this;if("restore"==a.type){var t="wxcard/restoreNotify?"+n.buildQuery({order_id:e.order_id||"",card_id:e.card_id||"",code:e.card_code||""});n.apiRequest("GET",t,null,function(e){i()},function(){})}else if("get"==a.type){var t="wxcard/getNotify?"+n.buildQuery({card_id:e.card_id||""});n.apiRequest("GET",t,null,function(e){i()},function(){})}else if("fission"==a.type){var t="wxcard/fissionNotify?",r={};r.card_id=e.card_id,r.code=[];for(var d=e.cardList||[],s=0;s<d.length;s++){var o=d[s];if(o.isSuccess){var c=o.cardExt,l=JSON.parse(c),f=l.code||"";r.code.push(f)}}n.apiRequest("POST",t,r,function(e){i(r.code)},function(){})}},e.toggleBtn=function(e){$("#card_btn").attr("disabled",e)},e.setUI=function(){var e=this;if("fission"==e.type){var i=$("#card_middle_bg").height(),a=$("#card_btn").height();$("#card_middle").height(i-a-8)}},n.changeTitle("卡券领取");var r=e.getParameters();e.load(r)})}]);