webpackJsonp([52],{0:function(e,o,n){"use strict";var t=n(4),r=n(1),a=n(6),i=n(7),u=n(13),s=n(3);r.prepare({requireLogin:!0,regEvents:{onSceneReturn:function(e){e=e||{},Navigation.reload(e.url)}}},function(){var e="当前网络繁忙，优惠券无法加载！",o="立即支付",d="正在支付 请稍候",l="该商品有地区限制，请使用快递可以送达的地址",c="请输入正确的手机号码",p="LastPaymentType",_="团长免单券领取成功!",f={buyAmount:2,freeAmount:1},m=function(e){return null==e?0:Math.floor(e/f.buyAmount)*f.freeAmount},g=r.getParameter("goods_id"),y=r.getParameter("group_order_id"),I=r.getParameter("group_id")||"",b=r.getParameter("sku_id"),h=r.getParameter("sel_address_id"),v=r.getParameter("tuan_free_from_wechat"),T=parseInt(r.getParameter("goods_number"))||1,w=m(T),C="",E=null,N=!1,P=!0,D=null,A=!1,R="http://pinduoduo.b0.upaiyun.com/coupons/",S={REACH:{bg_selected_url:R+"cp_bg_gray_selected.png",bg_url:R+"cp_bg_yellow_new.png",bg:R+"cp_bg_yellow_new.png",type:"现金券",color_selected:"coupon_style_gray",font_color:"coupon_style_yellow",color:"coupon_style_yellow"},NOT_REACH:{bg_selected_url:R+"cp_bg_gray_selected.png",bg_url:R+"cp_bg_red_new.png",bg:R+"cp_bg_red_new.png",type:"满减券",color_selected:"coupon_style_gray",font_color:"coupon_style_red",color:"coupon_style_red"},TUAN_REACH:{bg_selected_url:R+"cp_bg_gray_selected.png",bg_url:R+"cp_bg_group_new.png",bg:R+"cp_bg_group_new.png",type:"团长免单券",color_selected:"coupon_style_gray",font_color:"coupon_style_group",color:"coupon_style_group"}},G=!1,k=function(e,n,_,f){E=avalon.define({$id:"order",loaded:!1,userInteractionEnabled:!0,shopName:a.shop.name,errorMessage:"",payButtonText:o,weChatPayVisible:r.isWeChatPayAvailable(),aliPayVisible:r.isAliPayAvailable(),paymentType:f,skuStyleStr:"",haitao_Info:"",real_name:"",id_number:"",isReal_nameValid:!0,isId_numberValid:!0,hasIdtoPay:"",mallInfo:{mallID:0,name:"",logo:""},goodsInfo:{goodsID:0,name:"",thumbnailURL:"",price:""},addressInfo:{addressID:0,provinceID:0,receiver:"",mobile:"",addressType:"",address:""},couponInfos:[],selectedCoupon:{couponID:0,discount:0,description:"",cardID:""},couponListVisible:!1,info_Modification:!1,personalInfoVisible:!1,showXiaomiAd:r.isNativePlatform(),goodsNumber:T,showGoodsNumber:!1,canReduce:!1,canIncrease:!1,showFreeNumber:e.event_type==i.EVENT_TYPE.GET_EXTRA_FOR_FREE,freeNumber:w,skuInfo:{},showPhoneNumber:"5"==e.goods_type||"6"==e.goods_type,phoneNumber:"",couponVisible:!1,isUp:!1,checkPhoneNumber_:function(e){var o=/(^1)\d{10}$/;return o.test(e)?!0:!1},modify_id_info:function(){E.personalInfoVisible=!0,t(".personalInfo_detail").animate({width:"100%"},300),P=!1,D&&(r.showToast(u.messageFromCode(D)),D=null)},onReal_nameEdited:function(){E.loaded&&E.validateReal_name()},onId_numberEdited:function(){E.loaded&&E.validateId_number()},validateReal_name:function(){return E.isReal_nameValid=null!=E.real_name&&E.real_name.length>0},validateId_number:function(){var e=/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;return E.isId_numberValid=e.test(E.id_number)},validate_:function(){var e=!0;return E.validateId_number()||(e=!1),E.validateReal_name()||(e=!1),e},savePersonalInfo:function(){if(!E.validate_())return void(E.validateReal_name()?r.showToast("请输入正确的身份证号码"):E.validateId_number()?r.showToast("请输入正确的姓名"):r.showToast("请输入正确的身份证号码和姓名"));if(!/^[\u4e00-\u9fa5]{2,10}([.·]{0,1}[\u4e00-\u9fa5]+)*$/gi.test(E.real_name))return void r.showToast("请填写真实姓名");18==E.id_number.length&&"x"==E.id_number.charAt(17)&&(E.id_number=E.id_number.toUpperCase());var e=function(){E.hasIdtoPay=!0,E.personalInfoVisible=!1,E.info_Modification=!0,0!=P&&E.pay()},o=function(e){u.messageFromCode(e)},n={id_card_name:E.real_name,id_card_no:E.id_number};r.apiRequest("POST","user/card",n,e,o)},quit_save_personalInfo:function(){E.personalInfoVisible=!1,E.info_Modification=E.hasIdtoPay},editAddress:function(){E.userInteractionEnabled&&(E.addressInfo.addressID<=0||Navigation.forward("addresses.html?"+r.buildQuery(r.getParameters(),{sel_address_id:E.addressInfo.addressID,allowed_regions:C})))},toggleCouponList:function(e){if(null!=event&&(event.preventDefault(),event.stopPropagation()),E.userInteractionEnabled){var o=document.querySelector(".animate_set");if(null==o)return!1;if(null==e?E.couponListVisible=!E.couponListVisible:E.couponListVisible=e,E.couponListVisible){var n=document.querySelector(".coupons"),t=n.offsetHeight;o.style.height=t*E.couponInfos.length+10+"px"}else o.style.height="0px";return!1}},showCouponList:function(){null!=event&&(event.preventDefault(),event.stopPropagation()),E.couponVisible=!0,setTimeout(function(){E.isUp=!0},100)},hideCouponList:function(){E.isUp=!1,setTimeout(function(){E.couponVisible=!1},100)},selectCoupon:function(e){if(E.userInteractionEnabled&&!(0>e||e>=E.couponInfos.length)){var o=E.couponInfos[e];if(E.selectedCoupon.couponID==o.couponID)return void E.deselectCoupon();E.selectedCoupon.cardID=o.cardID||"",E.selectedCoupon.couponID=o.couponID,E.selectedCoupon.discount=o.discount.toFixed(2),E.selectedCoupon.description=o.description}},deselectCoupon:function(){E.userInteractionEnabled&&(E.selectedCoupon.cardID="",E.selectedCoupon.couponID=0,E.selectedCoupon.discount=0,E.selectedCoupon.description="")},selectPaymentType:function(e){E.paymentType=e},pay:function(){if(E.showPhoneNumber&&!E.checkPhoneNumber_(E.phoneNumber))return void r.showToast(c);if(E.userInteractionEnabled&&null!=E.paymentType){if(N&&0==E.hasIdtoPay)return P=!0,E.personalInfoVisible=!0,E.info_Modification=!1,t(".personalInfo_detail").animate({width:"100%"},300),void(D&&(r.showToast(u.messageFromCode(D)),D=null));E.setUserInteractionEnabled_(!1),E.payButtonText=d;var e=function(e,n,t){var a=u.messageFromCode(e);return E.isHandlingErrorShouldBackToHome_(e)?void r.showAlert(a,function(){Navigation.reset("index.html")}):void(E.isHandlingErrorShouldEditAddress_(e)?r.showConfirm(l,function(){Navigation.forward("addresses.html?"+r.buildQuery(r.getParameters(),{allowed_regions:C}))},function(){E.setUserInteractionEnabled_(!0),E.payButtonText=o}):E.isHandlingErrorShouldEditPersonalInfo_(e)?r.showAlert(a,function(){E.setUserInteractionEnabled_(!0),E.payButtonText=o,E.modify_id_info()}):E.isHandlingErrorShouldGoToGoods_(e)?r.showAlert(a,function(){Navigation.forward("goods.html?goods_id="+g)}):(t&&r.showToast(a),E.setUserInteractionEnabled_(!0),E.payButtonText=o))};r.isNativePlatform()||localStorage.setItem(p,E.paymentType.toString());var n=function(){return E.paymentType==i.PaymentType.WeChat?a.AppID.WeChat:E.paymentType==i.PaymentType.AliPay?r.isNativePlatform()?a.AppID.AliPay:a.AppID.AliPayWeb:a.AppID.WeChat},s={address_id:E.addressInfo.addressID,goods:[{sku_id:b,sku_number:E.goodsNumber}],app_id:n()};null!=I&&(s.group_id=I),null!=y&&(s.group_order_id=y);var _=E.getCouponOrCard("coupon");_.length>0&&(s.coupon_id=_[0]),E.showPhoneNumber&&(s.charge_mobile=E.phoneNumber),r.apiRequest("POST","order",s,function(o){0==(E.goodsInfo.price*E.goodsNumber-E.selectedCoupon.discount).toFixed(2)?r.apiRequest("GET","order/"+o.order_sn,null,function(e){var o=null;null!=e&&(o=e.group_order_id),Navigation.forward(Navigation.GroupUrl+"?group_order_id="+o)},function(){}):payment.pay(E.paymentType,o.order_sn,E.goodsInfo.name,function(n){e(n,null,!1),n==u.PrepayBusy.code&&Navigation.forward("order.html?order_sn="+o.order_sn)},!1)},function(o,n){e(o,n,!0)})}},showGroupRule:function(){Navigation.forward("tuan_rule.html")},isHandlingErrorShouldBackToHome_:function(e){return[u.ItemRemoved.code,u.OutOfStock.code,u.GroupInvalid.code,u.OverBuyLimit.code,u.OrderPayed.code].indexOf(e)>=0},isHandlingErrorShouldEditAddress_:function(e){return[u.AddressUnreachable.code].indexOf(e)>=0},isHandlingErrorShouldEditPersonalInfo_:function(e){return[u.PersonalInfoNoID.code].indexOf(e)>=0},isHandlingErrorShouldGoToGoods_:function(e){return[u.GroupCompleted.code].indexOf(e)>=0},setUserInteractionEnabled_:function(e){E.userInteractionEnabled=e;var o=document.querySelector("#btn_order_done");null!=o&&(e?o.style.opacity="1":o.style.opacity="0.5")},getCouponOrCard:function(e){if("coupon"==e&&""==E.selectedCoupon.cardID)return E.selectedCoupon.couponID>0?[E.selectedCoupon.couponID]:[];if("card"==e&&""!=E.selectedCoupon.cardID){var o=[],n={};return n.card_id=E.selectedCoupon.cardID,n.code=E.selectedCoupon.couponID,o.push(n),o}return[]},updateGoodsNumber:function(e){if(!A){E.canReduce=!0,E.canIncrease=!0;var o=E.goodsNumber+parseInt(e||"0",10);1>=o&&(o=1,E.canReduce=!1);var n=parseInt(E.goodsInfo.selectedGroup.order_limit);n>E.skuInfo.quantity&&(n=E.skuInfo.quantity),n>E.skuInfo.limit_quantity&&E.skuInfo.limit_quantity>0&&(n=E.skuInfo.limit_quantity),o>=n&&(E.canIncrease=!1,1==e&&o>n&&r.showToast(u.OverBuyLimit.message),o=n),o!=E.goodsNumber&&(E.selectedCoupon.discount=0,E.goodsNumber=o,E.freeNumber=m(E.goodsNumber),s.show(),A=!0,L(function(e){s.hide(),V(e,E.goodsInfo)}))}}}),null==E.paymentType?E.weChatPayVisible?E.paymentType=i.PaymentType.WeChat:E.aliPayVisible&&(E.paymentType=i.PaymentType.AliPay):E.weChatPayVisible||E.paymentType!=i.PaymentType.WeChat||(E.paymentType=i.PaymentType.AliPay),C=e.allowed_region||"",E.goodsInfo.goodsID=e.goods_id,E.goodsInfo.name=e.goods_name,E.goodsInfo.thumbnailURL=e.thumb_url,E.goodsInfo.selectedGroup=function(e){for(var o=e.group||[],n=0;n<o.length;n++)if(o[n].group_id==I)return E.goodsInfo.price=parseFloat(o[n].price)/100,o[n];return{}}(e),E.showGoodsNumber=parseInt(E.goodsInfo.selectedGroup.order_limit)>1,E.showFreeNumber=E.showFreeNumber&&E.showGoodsNumber,E.goodsInfo.selectedGroup.price&&(E.goodsInfo.selectedGroup.price=(E.goodsInfo.selectedGroup.price/100).toFixed(2));var v=e.sku;if(null!=v){for(var R=null,S=0;S<v.length;++S){var k=v[S];if(k.sku_id==b){R=k;break}}if(null!=R){E.skuInfo=R,E.skuInfo.quantity=parseInt(E.skuInfo.quantity),E.skuInfo.limit_quantity=parseInt(E.skuInfo.limit_quantity);var q=function(e){var o="";return e.forEach(function(e){o+=e.spec_key+":"+e.spec_value+" "}),o},O=R.specs||[];E.skuStyleStr=q(O)}}E.updateGoodsNumber();var x=null,F=null;H(n,function(e){return n=e,n.forEach(function(e){e.address_id==h&&(x=e),e.is_default==i.AddressClass.Default&&(F=e)}),null==x&&(x=F),null==x&&(x=n[0]),null!=x||G?(E.addressInfo.addressID=x.address_id,E.addressInfo.provinceID=x.province_id,E.addressInfo.receiver=x.name,E.addressInfo.mobile=x.mobile,void(E.addressInfo.address=x.address)):(G=!0,void Navigation.reload("address.html?"+r.buildQuery(r.getParameters(),{address_id:null,allowed_regions:C})))}),N&&(E.real_name=_.info.user_name||"",E.id_number=_.info.id_card||"",E.hasIdtoPay=!1),E.loaded=!0},V=function(o,n){if(null!=E){null==o&&(E.errorMessage=e);var t=o.coupons,r=(o.timestamp,[]);t.forEach(function(e){var o={cardID:"",shopName:a.shop.name,couponID:e.coupon_id,startTime:e.start_time,endTime:e.end_time,discount:0,description:e.batch_name,type:e.type,thumb_url:e.thumb_url};o.discount=parseFloat(e.discount)/100,o.cat_id=e.cat_id||"0",o.cat_name=e.cat_name||"无限制",o.coupon_style={},7==o.type?o.coupon_style=S.TUAN_REACH:e.discount==e.min_amount?o.coupon_style=S.REACH:o.coupon_style=S.NOT_REACH,r.push(o)}),r.sort(function(e,o){var n=Date.parse(e.endTime),t=Date.parse(o.endTime);return e.discount==o.discount?n-t:o.discount-e.discount}),E.couponInfos=r,E.selectCoupon(0)}},q=function(e,o){if(null!=E){null==e&&(E.errorMessage=LANG_LOAD_CARDS_FAILED);var n=e.coupons||[],t=o.parent_cat_id||"";n.forEach(function(e){var o={cardID:e.card_id,shopName:"微信卡券",couponID:e.coupon_id,startTime:e.start_time,endTime:e.end_time,discount:0,description:e.event_desc},n=e.event_template_values;null!=n&&(o.discount=parseInt(n.discount,10),o.cat_id=n.cat_id||"0",o.cat_name=n.cat_name||"无限制");var r=e.event_template_values.reach;if(o.coupon_style={},n.discount==n.reach?o.coupon_style=S.REACH:o.coupon_style=S.NOT_REACH,"undefined"!=r&&E.goodsInfo.price>parseInt(r,10)){if(""==o.cat_id)return;("0"==o.cat_id||o.cat_id==t)&&E.couponInfos.push(o)}}),E.couponInfos.sort(function(e,o){var n=Date.parse(e.endTime),t=Date.parse(o.endTime);return e.discount==o.discount?n-t:o.discount-e.discount}),E.selectCoupon(0)}},O=function(e){r.apiRequest("GET","goods/"+g+"?"+r.buildQuery({group_id:I}),null,function(o){var n=o;null!=n&&r.call(e,n)})},x=function(e){r.apiRequest("GET","addresses",null,function(o){var n=o||[];r.call(e,n)})},H=function(e,o){var n=e.length,t=null==C?[]:C.split(",");return t.length>0&&""!=C&&(e=e.filter(function(e){return t.indexOf(e.province_id)>=0})),n>0&&e.length<=0?void r.showConfirm(l,function(){r.call(o,e)},function(){Navigation.back()}):(e.length<=0&&!G&&(G=!0,Navigation.reload("address.html?"+r.buildQuery(r.getParameters(),{address_id:null,allowed_regions:C}))),void r.call(o,e))},L=function(e){var o=T;E&&E.goodsNumber&&(o=E.goodsNumber);var n="applicable_coupons?"+r.buildQuery({group_order_id:y,group_id:I,sku_number:o});r.apiRequest("GET",n,null,function(o){A=!1,r.call(e,o)},function(){A=!1,r.call(e)})},F=function(e){r.apiRequest("GET","user/card",null,function(o){r.call(e,o),E.hasIdtoPay=!0,E.info_Modification=!0},function(o,n){D=o,n=n||{},D==u.NoNameIDBefore&&(D=null),n=JSON.parse(n.error_msg||""),0==(n.id_card_no||"").length&&0==(n.id_card_name||"").length&&(D=null),r.call(e,n)},null,null,!0)},U=function(){var e=null,o=null,n=null,t=null,a=!1,u=!1,d=null,l=!1,c=function(r){null!=e&&null!=o&&null!=t&&(a||(a=!0,k(e,o,t,r),avalon.scan(document.body),s.hide()),null==n||u||(u=!0,V(n,e)),null==d||l||(l=!0,q(d,e)))},f=function(a){O(function(o){e=o,N=e.goods_type==i.GoodsType.OVERSEAS_TRANSSHIP||e.goods_type==i.GoodsType.OVERSEAS_DM,N?F(function(e){t={info:{user_name:e.id_card_name,id_card:e.id_card_no}},c(a)}):(t={},c(a))}),x(function(e){o=e,c(a)}),"true"==v?r.apiRequest("GET","coupon/free",null,function(e){r.showToast(_),L(function(e){n=e,c(a)})},function(e,o){r.showToast(o.error_msg),L(function(e){n=e,c(a)})},null,null,!0):L(function(e){n=e,c(a)})},m=localStorage.getItem(p);null!=m&&(m=parseInt(m,10)),f(m)};n(12)(function(){}),n(14)(function(e){window.payment=e,U()},function(){location.reload()})})},12:function(e,o,n){n(2),e.exports=function(e,o){n.e(6,function(t){t?o():e(n(15))})}},14:function(e,o,n){n(2),e.exports=function(e,o){n.e(7,function(t){t?o():e(n(23))})}}});