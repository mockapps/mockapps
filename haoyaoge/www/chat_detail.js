webpackJsonp([49],{0:function(e,t,n){"use strict";n(71);var s=n(4),a=n(1),r=n(5),o=n(3),i=n(6),l=n(11);l.alertNotSupport(function(){r.back()});var u=n(7),m=(n(25),n(10));a.prepare({requireLogin:!0,disablePullReload:!0},function(){function e(e){var t;t=e?new Date(1e3*e):new Date;var n=t.getFullYear(),s=t.getMonth()+1,a=t.getDate(),r=t.getHours(),o=t.getMinutes();return 10>o&&(o="0"+o),{year:n,month:s,day:a,hours:r,minute:o}}function t(e){for(var t=0;t<e.length;t++){var s=e[t],a=s.ts;if(0==t)s.time=n(a),s.ifShowTime=!0;else{var r=e[t-1].ts;a-r>h?(s.time=n(a),s.ifShowTime=!0):(s.time="",s.ifShowTime=!1)}}return e}function n(t){var n,s=e(),a=e(t);return n=s.year!=a.year||s.month!=a.month||s.day-a.day>1?a.year.toString()+"年"+a.month.toString()+"月"+a.day.toString()+"日 "+a.hours.toString()+":"+a.minute.toString():s.day-a.day==1?"昨天 "+a.hours.toString()+":"+a.minute.toString():a.hours.toString()+":"+a.minute.toString()}var c={GOODS:"【自动】我想咨询【{0}】相关的问题，商品链接为{1}",ORDER:"【自动】我的订单编号为{0}"},g={DEFAULT:0,IMAGE:1,FROM:2},f="请选择jpeg、png格式的图片",d="http://mobile.yangkeduo.com/goods.html?goods_id=",h=120,p=1e4,v=u.OFFICIAL_MALL_ID.Online;1==i.shop.shopID?v=u.OFFICIAL_MALL_ID.Hutaojie:3==i.shop.shopID&&(v=u.OFFICIAL_MALL_ID.Weipin);var y,S,w=s(".messageContainer"),A=s(".messageInnerContainer"),_=s(".messageContent"),I=s(window).height(),O=(w.height(),A.height(),navigator.userAgent||navigator.vendor||window.opera),M=0,T=!1,b=0,k=0,L=a.getParameter("mall_id"),N=a.getParameter("goods_id"),R=a.getParameter("order_sn"),D=!0;r.replaceURL(a.buildURL({goods_id:null,order_sn:null}));var x={authStatus:!0,sendStatus:!0},U=function(){l.request({cmd:"mall_online_customer_service",mall_id:L},function(e){var t=e.online||[],n=function(){var e=(new Date).getHours();return e>=u.Mall.ServiceStart&&e<u.Mall.ServiceEnd.DefaultMall};if(v!=L){if(0>=t){var s="mall/"+L+"/info";a.apiRequest("GET",s,null,function(e){var t=e.offline_note||u.Mall.NoCSOnline.NormalMall;a.showToast(t)})}}else n()||a.showToast(u.Mall.NoCSOnline.DefaultMall)})},F=function(){var e={cmd:"enter_conversation",conversation:{mall_id:L}};l.request(e,function(e){"fail"==e.result&&(x.sendStatus=!1,a.showToast("会话已被中止"))})},C=function(){var e={cmd:"leave_conversation",conversation:{mall_id:L}};l.send(e)},P=function(e){var t={cmd:"mark_read",conversation:{mall_id:L,ts:e.ts,msg_id:e.msg_id}};l.send(t);var n=JSON.parse(localStorage.getItem("LastPersonalMsg"))||{},s=n.key||0,a=n.time||0,r={key:s,time:a};s>=1&&(r.key=s-1,localStorage.setItem("LastPersonalMsg",JSON.stringify(r)))},q=function(e,n){D&&(N&&(D=!1,y.messageSend(a.format(c.GOODS,S.goodsName,S.url),g.FROM)),R&&(D=!1,y.messageSend(a.format(c.ORDER,R),g.FROM))),n=n||g.DEFAULT;var r={cmd:"send_message",message:{to:{role:"mall",mall_id:L},content:e,type:n}};l.request(r,function(r){if("ok"==r.result){var o=G(e),i=new Object;i={message:e,role:"customer",ts:J(),isUrl:o,time:"",type:n},n!=g.FROM&&y.messageArray.push(i),y.messageArray=t(y.messageArray),setTimeout(j,100),y.currentText="",s(".chatMessageSend").css({color:"#999","background-color":"white","border-radius":"5px",border:"solid 1px #999"}),y.canUploadImage()&&(y.showTextSend=!1,y.showImageSelect=!0)}else a.showToast("发送失败")})},E=function(e){D&&(N&&(D=!1,y.messageSend(a.format(c.GOODS,S.goodsName,S.url),g.FROM)),R&&(D=!1,y.messageSend(a.format(c.ORDER,R),g.FROM)));var t={cmd:"send_message",message:{to:{role:"mall",mall_id:L},content:e,type:"1"}};l.request(t,function(e){y.messageArray[y.messageArray.length-1].loading=!1,"ok"==e.result?y.messageArray[y.messageArray.length-1].fail=!1:(y.messageArray[y.messageArray.length-1].fail=!0,a.showToast("发送失败"))})},j=function(){w.scrollTop(w[0].scrollHeight-w[0].clientHeight)},G=function(e){var t="^((https|http|ftp|rtsp|mms)?://)",n=new RegExp(t);return n.test(e)?!0:!1},J=function(){return parseInt((new Date).getTime()/1e3)},W=function(e){U(),F();var n=[],s=[],a={cmd:"list",list:{"with":{role:"mall",id:L},start_index:0,size:5}};l.request(a,function(a){T=a.has_more;for(var r,o=a.messages,i=0;i<o.length;i++){var l=o[i].from.role;if("user"==l)break;if("mall_cs"==l){r=o[0];break}}r&&P(r);for(var i=0;i<o.length;i++){var u=new Object,l=o[i].from.role;"user"==l?u={message:o[i].content,role:"customer",ts:o[i].ts,time:"",type:o[i].type||0}:"mall_cs"==l&&(u={message:o[i].content,role:"mall",ts:o[i].ts,time:"",type:o[i].type||0}),1==o[i].type&&(u.message=o[i].content+"?"+(k--).toString(),s.unshift(u.message)),G(o[i].content)&&(u.isUrl=!0),M=o[i].msg_id,u.type!=g.FROM&&n.push(u)}n=t(n.reverse()),e.historyMessage=n,e.imageUrls=s,H(e)})},H=function(e){y=avalon.define({$id:"root",localIds:[],imageUrls:e.imageUrls,mallInfo:e.mallInfo,userInfo:e.userInfo,currentText:"",messageArray:e.historyMessage,showTextSend:!1,isDefaultMall:v==L,showImageSelect:!1,messageSend:function(e,t){_.focus();var n=y.currentText.trim();if(e)n=e;else if(""==n)return void a.showToast("发送消息不能为空");q(n,t)},sendExpression:function(){},viewChatImage:function(e,t){t||(event.stopPropagation(),a.viewImages(e,y.imageUrls))},queryLastTenMsg:function(){if(o.show(),!T)return o.hide(),void a.showToast("您暂时没有更多的消息了");var e={cmd:"list",list:{"with":{role:"mall",id:L},start_msg_id:M,size:11}};l.request(e,function(e){T=e.has_more;for(var n=e.messages,s=1;s<n.length;s++){var a=new Object,r=n[s].from.role;"user"==r?a={message:n[s].content,role:"customer",ts:n[s].ts,time:"",type:n[s].type||0}:"mall_cs"==r&&(a={message:n[s].content,role:"mall",ts:n[s].ts,time:"",type:n[s].type||0}),1==n[s].type&&(a.message=n[s].content+"?"+(k--).toString(),y.imageUrls.unshift(a.message)),G(n[s].content)&&(a.isUrl=!0),a.message&&a.type!=g.FROM&&(y.messageArray.unshift(a),y.messageArray=t(y.messageArray),M=n[s].msg_id)}o.hide()})},clickMessage:function(){if(null!=n.toLowerCase().match(/iphone/i)){var e=w.height()-A.height();e>0&&(I>500&&510>I?w.css("top","250px"):I>600&&610>I?w.css("top","290px"):I>660&&680>I&&w.css("top","310px"))}_.focus(),setTimeout(j,100)},forwardMall:function(){C(),r.forward("mall_page.html?mall_id="+L)},checkInput:function(){null!=n.toLowerCase().match(/android/i)&&(s(".chatMessageSend").css({color:"white","background-color":"#ef3237","border-radius":"5px",border:"solid 1px #ef3237"}),y.showTextSend=!0,y.canUploadImage()&&(y.showImageSelect=!1),y.currentText.trim()||(s(".chatMessageSend").css({color:"#999","background-color":"white","border-radius":"5px",border:"solid 1px #999"}),y.canUploadImage()&&(y.showTextSend=!1,y.showImageSelect=!0)))},canUploadImage:function(){if(!a.isNativePlatform())return!0;var e=a.getAppVersion();return a.isNativePlatform()&&e.length>0&&e>"1.1.2"?!0:!1},imageSelect:function(){a.isNativePlatform()&&(s("#messageInput").blur(),a.selectImageInNative(function(e){z(e)}))}}),y.showImageSelect=y.canUploadImage(),a.isNativePlatform()&&s(".sendPicOrVideo").remove(),m.Current!=m.Android||y.canUploadImage()||(y.showTextSend=!0),s("form").submit(function(){return y.messageSend(),!1});var n=navigator.userAgent||navigator.vendor||window.opera;if(null!=n.toLowerCase().match(/android/i)){var i=document.body.clientWidth-65;_.css("width",i),s(".sendPicBg").css("marginRight","13px")}else if(null!=n.toLowerCase().match(/iphone/i))if(y.showImageSelect){var i=document.body.clientWidth-56;_.css("width",i)}else{var i=document.body.clientWidth-20;_.css("width",i)}s(".sendPicOrVideo").change(function(){var e=this.files[0],t=/^(image\/jpeg|image\/png)$/i;return t.test(e.type)?void(a.isNativePlatform()||z(e)):void a.showToast(f)}),avalon.scan(),S=e.goodsInfo;var u={cmd:"latest_conversations",page:1,size:2};l.request(u,function(e){for(var t=e.conversations,n=0;n<t.length;n++)"mall_cs"==t[n].from.role&&"unread"==t[n].status&&t[n].from.mall_id!=L&&1==y.otherMallMessage}),l.onMessage(function(e){var n=e.message,s=e.response;if(null!=n&&"push"==s)if(n.from.mall_id==L){var a=new Object;a={role:"mall",message:n.content,ts:n.ts,time:"",type:n.type||0},y.messageArray.push(a),1==a.type&&(y.messageArray[y.messageArray.length-1].message=n.content+"?"+(++b).toString(),y.imageUrls.push(y.messageArray[y.messageArray.length-1].message)),t(y.messageArray),setTimeout(j,500),P(n)}else y.otherMallMessage=!0,""==y.messageFromOthers?y.messageFromOthers=1:y.messageFromOthers++,y.messageFromOthers>=100&&(y.messagesFromOthers=99)}),setTimeout(j,1e3)},z=function(e){var n,s=!0;if(setTimeout(function(){s&&(y.messageArray[y.messageArray.length-1].loading=!1,y.messageArray[y.messageArray.length-1].fail=!0)},15e3),a.isNativePlatform())n=e;else{var r=e;n=webkitURL.createObjectURL(r)}var o=new Object;o={type:"image",message:"",role:"customer",ts:J(),time:"",localId:"",imageUrl:"",loading:!0,fail:!1},y.messageArray.push(o),t(y.messageArray),a.compressImage(n,function(e){y.messageArray[y.messageArray.length-1].localId=e,setTimeout(j,200);var t={image:e,mall_id:L};a.apiRequest("POST","chat_image",t,function(e){s=!1;var t=e.url+"?"+(++b).toString();y.messageArray[y.messageArray.length-1].imageUrl=t,y.imageUrls.push(t),E(e.url)},function(){s=!1,y.messageArray[y.messageArray.length-1].loading=!1,y.messageArray[y.messageArray.length-1].fail=!0})})},V=function(){var e=s.Deferred(),t={},n=function(){a.apiRequest("GET","user/me",null,function(n){t.avatar=n.avatar||i.shop.logo,e.resolve()},function(){o.hide()})},r=s.Deferred(),l={},u=function(){a.apiRequest("GET","mall/"+L+"/info",null,function(e){l.mallName=e.mall_name,l.avatar=e.logo,r.resolve()},function(){o.hide()})},m=s.Deferred(),c={},g=function(){a.apiRequest("GET","goods/"+N,null,function(e){c.goodsName=e.goods_name,c.thumbUrl=e.thumb_url,c.price=(e.group[0].price/100).toFixed(2),c.url=d+N,m.resolve()},function(){o.hide()})};n(),u(),N?(g(),s.when(e,r,m).done(function(){o.hide();var e={mallInfo:l,userInfo:t,goodsInfo:c};W(e)}).fail(function(){o.hide()})):s.when(e,r).done(function(){o.hide();var e={mallInfo:l,userInfo:t};W(e)}).fail(function(){o.hide()})};_.on("blur",function(){null!=O.toLowerCase().match(/iphone/i)&&w.css("top","40px")}),w.on("touchstart",function(){_.blur()}),l.onAuthenticationResult(function(e){e&&F()}),l.keepAlive(),setInterval(l.keepAlive,p),V()})},11:function(e,t,n){var s=n(1),a=n(6),r=n(8);n(10);e.exports=function(){var e=3e4,t=1,n={Open:0,Close:1,Authentication:2,Message:3},o=null,i=0,l={},u={},m=[],c=0,g=!1,f=void 0!==window.WebSocket,d=function(){return null!=o&&o.readyState==WebSocket.OPEN},h=function(){d()||null!=o&&o.readyState==WebSocket.CONNECTING||!f||(o=new WebSocket(a.pushDomain+"?"+s.buildQuery({access_token:r.getAccessToken(),role:"user"})),o.onopen=function(){setTimeout(function(){y(),v(n.Open)},50)},o.onclose=function(){setTimeout(function(){g=!1,v(n.Close)},50)},o.onerror=function(e){},o.onmessage=function(e){if(null!=e&&null!=e.data){var t=JSON.parse(e.data);if(null!=t){var s=t.response,a="ok"===t.result;if(!a&&null!=t.result,"auth"==s)return a&&(g=!0),v(n.Authentication,a);var r=t.request_id;if(null!=r){var o=u[r];null!=o&&setTimeout(function(){o(t)},50)}v(n.Message,t)}}})},p=function(e,t){if(null==t)return null;var n=i++;return l[n]={type:e,handler:t},n},v=function(e){for(var t=[],n=1;n<arguments.length;++n)t.push(arguments[n]);for(var s in l){var a=l[s];a.type==e&&setTimeout(function(){a.handler.apply(null,t)},50)}},y=function(e){if(f){var n=null;return"object"==typeof e&&(n=t++,e.request_id=n,m.push(e)),d()?(m.forEach(function(e){o.send(JSON.stringify(e))}),m=[]):h(),n}};return{isOpen:d,isSupport:f,hasAuthenticated:function(){return f?g:!1},onOpen:function(e){return p(n.Open,e)},onClose:function(e){return p(n.Close,e)},onAuthenticationResult:function(e){return f?p(n.Authentication,e):void 0},onMessage:function(e){return f?p(n.Message,e):void 0},unregister:function(e){delete l[e]},keepAlive:function(){if(f)if(d()){var t=Date.now();t-c>=e&&(y({cmd:"heartbeat"}),c=t)}else h()},send:function(e){f&&y(e)},request:function(e,t){if(f){var n=y(e);return null==n||null==t?n:void(u[n]=t)}},hasNewMsg:function(e,t){if(f&&r.hasAccessToken()){var n=JSON.parse(localStorage.getItem("LastPersonalMsg"))||{},a=n.key||0,o=n.time||0;if(0==a||e){var i=Date.now().toString(),l={key:a,time:o};if(3e4>i-o&&!e)return l.time=i,void localStorage.setItem("LastPersonalMsg",JSON.stringify(l));var m=0,c=y({cmd:"latest_conversations",page:1,size:20});u[c]=function(e){for(var n=e.conversations,a=document.querySelector("#footer_personal i"),r=0;r<n.length;r++)"read"!=n[r].status&&m++;null!=a&&0!=m&&a.classList.add("fb-badge1"),l.key=m,l.time=i,localStorage.setItem("LastPersonalMsg",JSON.stringify(l)),null!=t&&s.call(t,m)}}}},alertNotSupport:function(e){f||s.showAlert("您的系统版本不支持这个功能(Android系统版本至少为4.3)",function(){s.call(e)})}}}()},71:function(e,t){}});