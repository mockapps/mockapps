webpackJsonp([48],{0:function(t,n,e){"use strict";e(72);var o=e(4),a=e(1),i=e(5),r=e(3),s=e(6),u=e(11);u.alertNotSupport(function(){i.back()});var l=e(7);a.prepare({requireLogin:!0,regEvents:{onSceneReturn:i.reload}},function(){var t=20,n=20,e=l.OFFICIAL_MALL_ID.Online;1==s.shop.shopID?e=l.OFFICIAL_MALL_ID.Hutaojie:3==s.shop.shopID&&(e=l.OFFICIAL_MALL_ID.Weipin);var c,f=0,g=!1,d=!0,h=!1,v=[],p=function(t){return 10>t?"0"+t:t},m=function(t,o,i){v=[];var r={cmd:"latest_conversations",page:1,size:t};u.request(r,function(t){var r=t.conversations,s=[],u=!1;g=t.has_more;for(var l=0;l<r.length;l++){var c=new Object,h=r[l];c.status=h.status,c.mallID=h.from.mall_id||h.to.mall_id,s.push(c.mallID),1==h.type?c.lastMsg="图片":2==h.type?c.lastMsg="...":c.lastMsg=h.content;var S=(new Date).getDate(),L=new Date(1e3*h.ts),D=L.getFullYear()%100,I=L.getMonth()+1,_=L.getDate(),y=p(L.getHours()),M=p(L.getMinutes()),O=D.toString()+"-"+I.toString()+"-"+_.toString(),k=y.toString()+":"+M.toString(),A=S==_;c.date=O,c.dateTime=k,c.isToday=A,c.mallID==e?(c.isDefault=!0,v.unshift(c),u=!0):v.push(c)}if(!u){var c=new Object;c.status="read",c.mallID=e,s.push(c.mallID),c.date="",c.isToday=!1,c.isDefault=!0,v.unshift(c)}var w=function(){for(var t="malls",n=0;n<s.length;n++)t+=(n>0?"&":"?")+"mall_ids[]="+s[n];return t};return 0==s.length?(d=!1,void a.call(i)):void a.apiRequest("GET",w(),null,function(t){for(var e=t,r=0;r<e.length;r++)for(var s=0;s<v.length;s++)e[r].mall_id==v[s].mallID&&(v[s].mallName=e[r].mall_name,v[s].avatar=e[r].logo);0==o&&"unread"==v[v.length-1].status&&g&&m(f+n),f=v.length,a.call(i)},function(){})})};u.keepAlive();var S=function(t){c=avalon.define({$id:"root",anyMessage:d,chatList:t,isLoading:!1,forwardChatDetail:function(t){i.forward("chat_detail.html?mall_id="+t)},goBack:function(){i.back()}}),avalon.scan(),u.onMessage(function(n){var e=n.message,o=n.response;null!=e&&"push"==o&&m(f,!1,function(){c.chatList=[],c.chatList=t})}),I()},L=function(){m(t,!1,function(){r.hide(),S(v)})},D=function(){h||g&&(h=!0,c.isLoading=!0,m(f+n,!0,function(){setTimeout(function(){c.isLoading=!1,c.chatList=[],c.chatList=v,h=!1},500)}))},I=function(){o(document).scroll(function(){null!=c&&o(document).scrollTop()+o(window).height()>=o(document).height()&&D()})};L()})},11:function(t,n,e){var o=e(1),a=e(6),i=e(8);e(10);t.exports=function(){var t=3e4,n=1,e={Open:0,Close:1,Authentication:2,Message:3},r=null,s=0,u={},l={},c=[],f=0,g=!1,d=void 0!==window.WebSocket,h=function(){return null!=r&&r.readyState==WebSocket.OPEN},v=function(){h()||null!=r&&r.readyState==WebSocket.CONNECTING||!d||(r=new WebSocket(a.pushDomain+"?"+o.buildQuery({access_token:i.getAccessToken(),role:"user"})),r.onopen=function(){setTimeout(function(){S(),m(e.Open)},50)},r.onclose=function(){setTimeout(function(){g=!1,m(e.Close)},50)},r.onerror=function(t){},r.onmessage=function(t){if(null!=t&&null!=t.data){var n=JSON.parse(t.data);if(null!=n){var o=n.response,a="ok"===n.result;if(!a&&null!=n.result,"auth"==o)return a&&(g=!0),m(e.Authentication,a);var i=n.request_id;if(null!=i){var r=l[i];null!=r&&setTimeout(function(){r(n)},50)}m(e.Message,n)}}})},p=function(t,n){if(null==n)return null;var e=s++;return u[e]={type:t,handler:n},e},m=function(t){for(var n=[],e=1;e<arguments.length;++e)n.push(arguments[e]);for(var o in u){var a=u[o];a.type==t&&setTimeout(function(){a.handler.apply(null,n)},50)}},S=function(t){if(d){var e=null;return"object"==typeof t&&(e=n++,t.request_id=e,c.push(t)),h()?(c.forEach(function(t){r.send(JSON.stringify(t))}),c=[]):v(),e}};return{isOpen:h,isSupport:d,hasAuthenticated:function(){return d?g:!1},onOpen:function(t){return p(e.Open,t)},onClose:function(t){return p(e.Close,t)},onAuthenticationResult:function(t){return d?p(e.Authentication,t):void 0},onMessage:function(t){return d?p(e.Message,t):void 0},unregister:function(t){delete u[t]},keepAlive:function(){if(d)if(h()){var n=Date.now();n-f>=t&&(S({cmd:"heartbeat"}),f=n)}else v()},send:function(t){d&&S(t)},request:function(t,n){if(d){var e=S(t);return null==e||null==n?e:void(l[e]=n)}},hasNewMsg:function(t,n){if(d&&i.hasAccessToken()){var e=JSON.parse(localStorage.getItem("LastPersonalMsg"))||{},a=e.key||0,r=e.time||0;if(0==a||t){var s=Date.now().toString(),u={key:a,time:r};if(3e4>s-r&&!t)return u.time=s,void localStorage.setItem("LastPersonalMsg",JSON.stringify(u));var c=0,f=S({cmd:"latest_conversations",page:1,size:20});l[f]=function(t){for(var e=t.conversations,a=document.querySelector("#footer_personal i"),i=0;i<e.length;i++)"read"!=e[i].status&&c++;null!=a&&0!=c&&a.classList.add("fb-badge1"),u.key=c,u.time=s,localStorage.setItem("LastPersonalMsg",JSON.stringify(u)),null!=n&&o.call(n,c)}}}},alertNotSupport:function(t){d||o.showAlert("您的系统版本不支持这个功能(Android系统版本至少为4.3)",function(){o.call(t)})}}}()},72:function(t,n){}});